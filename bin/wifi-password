#!/bin/bash
# wifi-password - Get the password for the current or specified WiFi network
# Usage: wifi-password [network_name]
#        wifi-password -l  (list saved networks)

set -e

list_saved_networks() {
    security dump-keychain 2>/dev/null | grep -B 5 "AirPort network password" | grep "acct" | sed 's/.*<blob>="\([^"]*\)".*/\1/'
}

get_current_ssid() {
    local ssid=""

    # Method 1: networksetup (older macOS)
    ssid=$(networksetup -getairportnetwork en0 2>/dev/null | grep -v "not associated" | sed 's/Current Wi-Fi Network: //')
    if [[ -n "$ssid" ]]; then
        echo "$ssid"
        return
    fi

    # Method 2: wdutil (requires sudo, modern macOS) - often redacted
    ssid=$(sudo wdutil info 2>/dev/null | awk '/^ *SSID *:/ {gsub(/<redacted>/, ""); print substr($0, index($0, ":")+2)}' | grep -v '^$' | head -1)
    if [[ -n "$ssid" ]]; then
        echo "$ssid"
        return
    fi
}

get_password() {
    local ssid="$1"
    security find-generic-password -wa "$ssid" 2>/dev/null
}

main() {
    # Handle -l flag to list networks
    if [[ "$1" == "-l" || "$1" == "--list" ]]; then
        echo "Saved WiFi networks:"
        list_saved_networks
        exit 0
    fi

    local ssid="$1"

    # If no SSID provided, try to get current network
    if [[ -z "$ssid" ]]; then
        ssid=$(get_current_ssid)

        if [[ -z "$ssid" ]]; then
            echo "Could not auto-detect current network (macOS privacy restriction)" >&2
            echo "" >&2
            echo "Saved networks:" >&2
            list_saved_networks | head -10 >&2
            echo "" >&2
            echo "Usage: wifi-password \"network name\"" >&2
            exit 1
        fi
    fi

    echo "Network: $ssid"

    password=$(get_password "$ssid")

    if [[ -z "$password" ]]; then
        echo "Error: Could not retrieve password for '$ssid'" >&2
        echo "Make sure the password is stored in your keychain" >&2
        exit 1
    fi

    echo "Password: $password"

    # Copy to clipboard if pbcopy is available
    if command -v pbcopy &>/dev/null; then
        echo -n "$password" | pbcopy
        echo "(Copied to clipboard)"
    fi
}

main "$@"

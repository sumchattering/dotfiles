#!/bin/bash
# kill-orphans - Kill orphaned node/workerd processes from old dev sessions
# Usage: kill-orphans        (dry run - shows what would be killed)
#        kill-orphans -f     (actually kill the processes)
#        kill-orphans -a     (kill ALL node processes except current shell's children)

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

FORCE=false
ALL=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -f|--force)
            FORCE=true
            shift
            ;;
        -a|--all)
            ALL=true
            shift
            ;;
        -h|--help)
            echo "Usage: kill-orphans [options]"
            echo ""
            echo "Options:"
            echo "  -f, --force    Actually kill the processes (default is dry run)"
            echo "  -a, --all      Kill ALL node processes (except current shell's children)"
            echo "  -h, --help     Show this help message"
            echo ""
            echo "By default, identifies orphans as node/workerd processes that:"
            echo "  - Have been running for more than 1 day"
            echo "  - Are from directories outside current working directory"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

# Get current shell's process group to avoid killing ourselves
CURRENT_PGID=$(ps -o pgid= -p $$ | tr -d ' ')

get_orphan_pids() {
    local pids=()
    local now=$(date +%s)
    local one_day_ago=$((now - 86400))

    # Get all node-related processes
    while IFS= read -r line; do
        [[ -z "$line" ]] && continue

        local pid=$(echo "$line" | awk '{print $2}')
        local start_time=$(echo "$line" | awk '{print $9}')
        local cmd=$(echo "$line" | awk '{for(i=11;i<=NF;i++) printf $i" "; print ""}')

        # Skip if it's in our process group
        local pgid=$(ps -o pgid= -p "$pid" 2>/dev/null | tr -d ' ')
        [[ "$pgid" == "$CURRENT_PGID" ]] && continue

        # Check if process started before today (heuristic for old processes)
        # ps shows time as HH:MM or H:MMPM for today's processes
        # Older processes show dates like "Mon06PM", "15Jan26", "17Jan26"
        # Today's processes match patterns like "3:25PM", "10:02AM", "15:30"
        if [[ ! "$start_time" =~ ^[0-9]{1,2}:[0-9]{2} ]]; then
            # Not a time format, so it's an older process showing a date
            pids+=("$pid")
        fi
    done < <(ps aux | grep -E '(node|workerd|esbuild)' | grep -v grep | grep -v "kill-orphans")

    echo "${pids[@]}"
}

get_all_node_pids() {
    local pids=()

    while IFS= read -r line; do
        [[ -z "$line" ]] && continue

        local pid=$(echo "$line" | awk '{print $2}')

        # Skip if it's in our process group
        local pgid=$(ps -o pgid= -p "$pid" 2>/dev/null | tr -d ' ')
        [[ "$pgid" == "$CURRENT_PGID" ]] && continue

        pids+=("$pid")
    done < <(ps aux | grep -E '(node|workerd|esbuild)' | grep -v grep | grep -v "kill-orphans")

    echo "${pids[@]}"
}

show_process() {
    local pid=$1
    ps -p "$pid" -o pid=,etime=,command= 2>/dev/null | head -c 120
    echo ""
}

main() {
    local pids

    if [[ "$ALL" == true ]]; then
        pids=($(get_all_node_pids))
        echo -e "${YELLOW}All node/workerd processes:${NC}"
    else
        pids=($(get_orphan_pids))
        echo -e "${YELLOW}Orphaned node/workerd processes (running > 1 day):${NC}"
    fi

    if [[ ${#pids[@]} -eq 0 ]]; then
        echo -e "${GREEN}No orphan processes found.${NC}"
        exit 0
    fi

    echo ""
    for pid in "${pids[@]}"; do
        show_process "$pid"
    done
    echo ""

    if [[ "$FORCE" == true ]]; then
        echo -e "${RED}Killing ${#pids[@]} process(es)...${NC}"
        for pid in "${pids[@]}"; do
            kill -9 "$pid" 2>/dev/null && echo "Killed PID $pid" || echo "Failed to kill PID $pid"
        done
        echo -e "${GREEN}Done.${NC}"
    else
        echo -e "${YELLOW}Dry run - use -f to actually kill these processes${NC}"
        echo "Example: kill-orphans -f"
    fi
}

main
